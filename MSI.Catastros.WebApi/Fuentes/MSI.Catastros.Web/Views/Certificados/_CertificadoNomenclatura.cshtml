@model MSI.Catastros.Web.Funcionalidad.Certificados.CertificadosViewModel
<fieldset class="formulario p-3">
    <legend id="legInforme" style="margin-bottom:-10px;">Certificado de Nomenclatura</legend>
    @using (Html.BeginForm("Registrar", "Certificados", FormMethod.Post, new { id = "frmCertificadoNomen", name = "frmCertificadoNomen" }))
    {
        @Html.TextBoxFor(m => m.FiltrarCodigoCertificado, new { @class = "form-control change", type = "hidden" })
        @Html.AntiForgeryToken()

        <input type="hidden" class="form-control" id="AnioCertificado" name="AnioCertificado" value="@Model.FiltrarCodigoPeriodo" />
        <input type="hidden" class="form-control" id="AnioSolicitud" name="AnioSolicitud" value="@Model.CodAnioSolicitud" />
                <div class="row mt-3 px-3" style="display:none;">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="control-label" id="lblTitulo" for="Titulo">Numero de Documento</label>
                            @Html.TextBoxFor(m => m.Titulo, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                </div>
                <div class="row mt-3 px-3">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblCodigoCatastral" for="CodigoCatastral">Código Catastral</label>
                            <input type="text" class="form-control" id="CodigoCatastralVer" name="CodigoCatastralVer" disabled />
                            @Html.TextBoxFor(m => m.CodigoCatastral, new { @class = "form-control change", disabled = true, type = "hidden" })
                        </div>
                    </div>
                    <div class=" col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblCodigoUnico" for="CodigoUnico">Código Unico Cat.</label>
                            @*@Html.TextBoxFor(m => m.Parrafo1, new { @class = "form-control change" })*@
                            @Html.TextBoxFor(m => m.CodigoUnico, new { @class = "form-control change", type = "hidden", disabled = true })
                            @Html.TextBoxFor(m => m.CUC, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblFechaGeneracion" for="FechaGeneracion">Fecha de Emisión</label>
                            @Html.TextBoxFor(m => m.FechaGeneracion, new { @class = "form-control change", type = "date", disabled = true })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblNumeroSolicitud" for="NumeroSolicitud">N° Expediente</label>
                            @Html.TextBoxFor(m => m.NumeroSolicitud, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                </div>
                <div class="row  px-3">
                    <div id="divSub1" class="col-md-6">
                        <div class="form-group">
                            <label class="control-label" id="lblPartida" for="Partida">Antecedentes del predio</label>
                            <select id="Partida" class="" multiple="multiple"></select>
                        </div>
                    </div>
                    <div id="divSub2" class="col-md-6">
                        <div class="form-group">
                            <label class="control-label" id="lblDirección" for="Direccion">Dirección</label>
                            @Html.TextAreaFor(m => m.Direccion, new { @class = "form-control change", rows = "1" })
                        </div>
                    </div>
                </div>
                <div class="row px-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="control-label" id="lblUrbanizacion" for="UnidadDireccion">Vías</label>
                            @Html.TextBoxFor(m => m.UnidadDireccion, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                </div>
                <hr class="mx-3 mt-1 mb-0" />
                <div class="row px-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label" id="lblUrbanizacion" for="Urbanizacion">Urbanizacion</label>
                            @Html.TextBoxFor(m => m.Urbanizacion, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblUrbanizacion" for="Urbanizacion">Manzana</label>
                            @Html.TextBoxFor(m => m.ManzanaUrbana, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblUrbanizacion" for="Urbanizacion">Lote</label>
                            @Html.TextBoxFor(m => m.LoteUrbano, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" id="lblUrbanizacion" for="Urbanizacion">SubLote</label>
                            @Html.TextBoxFor(m => m.SubLoteUrbano, new { @class = "form-control change", disabled = true })
                        </div>
                    </div>
                </div>
                <div class="row px-3">
                </div>
                <div class="row px-3">
                    <div class="col-md-2 Informes">
                        <button id="btnAgregarVias" type="button" class="btn btn-success  mb-2 btn-sm btn-block glyphicon glyphicon-plus-sign">
                            <span style="font-family:'Open Sans'">Agregar Nomenclatura de la Vía</span>
                        </button>
                    </div>
                    <div class="col-md-12">
                        <table id="tablaNomenclatura" style="width:100%" class="table responsive display table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Acciones</th>
                                    <th>Vía Frente</th>
                                    <th>Nombre Anterior Vía</th>
                                    <th>Vía Esquina</th>
                                    <th>Nombre Anterior Vía Esquina</th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                    <th style="display:none;"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="row  px-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="control-label" id="lblAnotaciones" for="Anotaciones">Anotaciones</label>
                            @Html.TextAreaFor(m => m.Anotaciones, new { @class = "form-control change", rows = "5" })
                        </div>
                    </div>
                </div>


    }
</fieldset>
<div id="modalCertificadoDetalle" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="RegistrarCertificadoDetalle" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-hidden="true">
                    &times;
                </button>
                <h5 id="TituloExpediente">Nomenclatura de la Vía</h5>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <input type="hidden" id="CodigoVia" />
                    <input type="hidden" id="CodigoViaEsq" />
                    <div class="form-group">
                        <label class="control-label col-md-2" id="lblNombreVia" for="NombreVia">Vía</label>
                        <div class="col-md-10">
                            <select id="NombreVia" class="form-control"><option value=""> - Seleccione la vía - </option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-2" id="lblNombreViaAnt" for="NombreViaAnt">Nombre Vía Ant.</label>
                        <div class="col-md-10">
                            <input type="text" id="NombreViaAnt" disabled class="form-control">
                            <input type="hidden" id="TipoVia" disabled>
                            <input type="hidden" id="TipoViaAnt" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-2" id="lblNombreViaEsq" for="NombreViaEsq">Vía Esq.</label>
                        <div class="col-md-10">
                            <select id="NombreViaEsq" disabled class="form-control"><option value=""> - Seleccione la vía esq. - </option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-2" id="lblNombreViaAnt" for="NombreViaEsqAnt">Nombre Vía  Esq. Ant.</label>
                        <div class="col-md-10">
                            <input type="text" id="NombreViaEsqAnt" disabled class="form-control">
                            <input type="hidden" id="TipoViaEsq" disabled>
                            <input type="hidden" id="TipoViaEsqAnt" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="col-md-offset-2 col-md-10 Informes">

                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button id="btnGrabarVia" type="button" class="btn btn-success">Grabar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/assets/vendor/bootstrap-multiselect/bootstrap-multiselect.js"></script>
<script>
    if ($('#NombreAreaSolicitante').val() == "") {
        $('#NombreTipoDocumento').val("");
    }
    RecuperarUrbanizacion();
    RecuperarViasEsq('03');
    var enlaceDocu = "@Url.Content("~/Certificados/CargarUnidadRRPP")";
    var codCat = $('#CodigoCatastral').val();
    $('#CodigoCatastralVer').val(codCat.slice(0, 2) + "-" + codCat.slice(2, 4) + "-" + codCat.slice(4, 7) + "-" + codCat.slice(7, 10) + "-" + codCat.slice(10, 12) + "-" + codCat.slice(12, 14) + "-" + codCat.slice(14, 16) + "-" + codCat.slice(16, 19))
    $.post(enlaceDocu, { CodigoUnico: $('#CodigoUnico').val(), Tipo: '1' }, function (r) {
        $('#Partida').children('option:not(:first)').remove();
        $.each(r.data, function (ind, item) {
            $('#Partida').append($('<option>').text(item.Text).attr('value', item.Value));
        });
        $('#Partida').multiselect({
            buttonWidth: '100%',
            allSelectedText: "Todos los documentos seleccionados",
            buttonClass: 'btn btn-default btn-sm',
            nonSelectedText: 'Seleccione una o más Partidas',
        });
        var ListaPartida;
        if ("@Model.PartidaString") {
            ListaPartida = "@Model.PartidaString".split("/");
            $('#Partida').multiselect('select', ListaPartida);
        }
    });
    tablaNomenclatura = $("#tablaNomenclatura").DataTable({
        "ajax": {
            "url": "@Url.Content("~/Certificados/CargarCertificadoNomenclatura")", "type": "POST", "datatype": "json",
            "data": function (d) {
                d.FiltrarCodigoCertificado = $('#FiltrarCodigoCertificado').val(); d.FiltrarCodigoTipoCertificado = $('#FiltrarCodigoTipoCertificado').val();
                d.FiltrarCodigoPeriodo = @Model.FiltrarCodigoPeriodo.ToString(); d.CodAnioSolicitud= @Model.CodAnioSolicitud.ToString();
            }
        },
        "language": { "lengthMenu": "", "info": "", "emptyTable": "" }, "processing": true, "serverSide": false, "paging": false,

        "columns": [
            { 'render': function (data, type, full, meta) { return '<button data-toggle="tooltip" title="Eliminar" class="btn mr-1 text-center btnDeleteNomenclatura btn-default btn-xs glyphicon glyphicon-trash" type="button" ></button>'; }, "className": "text-center", "width": "40px" },
            { "data": "NombreVia", "className": "text-center" },
            { "data": "NombreViaAnt", "className": "text-center" },
            { "data": "NombreViaEsq", "className": "text-center" },
            { "data": "NombreViaEsqAnt", "className": "text-center" },
            { "data": "CodigoVia", "className": "hide_column" },
            { "data": "CodigoViaEsq", "className": "hide_column" },
            { "data": "FiltrarCodigoCorrelativo", "className": "hide_column" },
            { "data": "TipoVia", "className": "hide_column" },
            { "data": "TipoViaAnt", "className": "hide_column" },
            { "data": "TipoViaEsq", "className": "hide_column" },
            { "data": "TipoViaEsqAnt", "className": "hide_column" }
        ]
    });
    $("#tablaNomenclatura tbody").on('click', 'button.btnDeleteNomenclatura', function (event) {
        var data = tablaNomenclatura.row($(this).parents('tr')).data();
        var itemTabla = this;
        bootbox.confirm({
            title: "Mensaje del Sistema", message: "¿Esta seguro de borrar el registro?",
            buttons: { confirm: { label: '<i class="fa fa-trash"></i> Eliminar ', className: "btn btn-danger" }, cancel: { label: '<i class="fa fa-times"></i> Cancelar' } },
            callback: function (result) {
                if (result) {
                    if (data.FiltrarCodigoCorrelativo) {
                        $.post("@Url.Content("~/Certificados/EliminarCertificadoDetalle")",
                            {
                                FiltrarCodigoCertificado: $('#FiltrarCodigoCertificado').val(), FiltrarCodigoTipoCertificado: $('#FiltrarCodigoTipoCertificado').val(),
                                FiltrarCodigoCorrelativo: data.FiltrarCodigoCorrelativo, FiltrarCodigoPeriodo: @Model.FiltrarCodigoPeriodo.ToString(),
                            }, function (response) {
                                tablaNomenclatura.row($(itemTabla).parents('tr')).remove().draw();
                            });
                    } else {
                        tablaNomenclatura.row($(itemTabla).parents('tr')).remove().draw();
                    }
                }
            }
        });

    });
    $('#btnAgregarVias').click(function () {
        event.stopPropagation();
        RecuperarUbicacionCert();
        RecuperarUrbanizacion();
        $('#modalCertificadoDetalle').modal('show')
        $('#modalCertificadoDetalle').on('shown.bs.modal', function () {
            $('#NombreVia').focus().select()
        })


    });
    $('#btnGrabarVia').click(function () {
        var item = tablaNomenclatura.data().count() + 1;
        var codigo = $('#NombreVia').val();
        var ind1 = codigo.indexOf("|") + 1;
        var ind2 = codigo.indexOf("|", ind1) + 1;
        var ind3 = codigo.indexOf("|", ind2) + 1;
        var ind4 = codigo.indexOf("|", ind3) + 1;
        var ind5 = codigo.indexOf("|", ind4) + 1;
        var codigoesq = $('#NombreViaEsq').val();
        var indesq1 = codigoesq.indexOf("|") + 1;
        var indesq2 = codigoesq.indexOf("|", indesq1) + 1;
        var indesq3 = codigoesq.indexOf("|", indesq2) + 1;
        var indesq4 = codigoesq.indexOf("|", indesq3) + 1;
        var NombreEsquinaAnterior = $('#NombreViaEsqAnt').val();



        tablaNomenclatura.row.add({
            "NombreVia": codigo.substring(ind3, ind4 - 1),
            "NombreViaAnt": $('#NombreViaAnt').val(),
            "NombreViaEsq": codigoesq.substring(indesq2, indesq3 - 1),
            "TipoVia": $('#TipoVia').val(),
            "TipoViaAnt": $('#TipoViaAnt').val(),
            "TipoViaEsq": codigoesq.substring(indesq1, indesq2 - 1),
            "CodigoVia": codigo.substring(ind1, ind2 - 1),
            "CodigoViaEsq": codigoesq.substring(0, indesq1 - 1),
            "FiltrarCodigoCorrelativo": "",
            "NombreViaEsqAnt": $('#NombreViaEsqAnt').val(),
            "TipoViaEsqAnt": codigoesq.substring(indesq3, indesq4 - 1),





        }).draw();
        $('#modalCertificadoDetalle').modal('hide')
    });
    $('#NombreVia').change(function () {
        console.log("vfvf");
        if (this.value) {
            var codigo = this.value;
            //0FLAG1 - 1CODVIA2 - 2TXTTIPOVIA3 - 3TXTVIA4 - 4TXTTIPOVIAANT5 - 5TXTVIAANTE
            var ind1 = codigo.indexOf("|") + 1;
            var ind2 = codigo.indexOf("|", ind1) + 1;
            var ind3 = codigo.indexOf("|", ind2) + 1;
            var ind4 = codigo.indexOf("|", ind3) + 1;
            var ind5 = codigo.indexOf("|", ind4) + 1;
            $('#TipoVia').val(codigo.substring(ind2, ind3 - 1));
            $('#TipoViaAnt').val(codigo.substring(ind4, ind5 - 1));
            $('#NombreViaAnt').val(codigo.substring(ind5));
            RecuperarViasEsq();

            if (codigo.substring(0, ind1 - 1) == "010001") {
                $('#NombreViaEsq').removeAttr('disabled').focus().select();
                RecuperarViasEsq();

            } else {
                $('#NombreViaEsq').attr('disabled', 'disabled');
            }
        }
    });
    $('#NombreViaEsq').change(function () {
        if (this.value) {
            var codigoE = this.value;
            //0FLAG1 - 1CODVIA2 - 2TXTTIPOVIA3 - 3TXTVIA4 - 4TXTTIPOVIAANT5 - 5TXTVIAANTE
            var ind1E = codigoE.indexOf("|") + 1;
            var ind2E = codigoE.indexOf("|", ind1E) + 1;
            var ind3E = codigoE.indexOf("|", ind2E) + 1;
            var ind4E = codigoE.indexOf("|", ind3E) + 1;
            var ind5E = codigoE.indexOf("|", ind4E) + 1;
            //  $('#NombreViaEsqAnt').val(codigo.substring(ind2, ind3 - 1));
            $('#TipoViaEsqAnt').val(codigoE.substring(ind3E, ind4E - 1));
            $('#NombreViaEsqAnt').val(codigoE.substring(ind4E));

        }
    });

    function RecuperarUbicacionCert(ubicacion) {
        var URLObservacion = "@Url.Content("~/Certificados/BuscarUbicacionTipo")";
        var Codigo = $('#CodigoCatastral').val();
        $.post(URLObservacion, {
            FiltrarCodigoTipoInforme: $('#FiltrarCodigoTipoInforme').val(), FiltrarCodigoTipoSolicitud: $('#FiltrarCodigoTipoSolicitud').val(),
            FiltrarCodigoTipoDocumentoReg: $('#FiltrarCodigoTipoDocumentoReg').val(), FiltrarNumeroSolicitud: $('#FiltrarNumeroSolicitud').val(), CodAnioSolicitud: @Model.CodAnioSolicitud.ToString(),
            CodigoSector: Codigo.substring(3, 5), CodigoManzana: Codigo.substring(6, 9), CodigoLote: Codigo.substring(10, 13),
            CodigoEdificacion: Codigo.substring(14, 16), CodigoEntrada: Codigo.substring(17, 19), CodigoPiso: Codigo.substring(20, 22), CodigoUnidad: Codigo.substring(23, 26),
        },
        function (r) {
            $('#NombreVia').children('option:not(:first)').remove();
            $.each(r.SolicitudUnidad, function (ind, item) {
                $('#NombreVia').append($('<option>').text(item.Ubicacion).attr('value', item.Unidad));
            });
            if (ubicacion) {
                $('#NombreVia').val(ubicacion);
            }
        });
    }
    function RecuperarViasEsq(codlado) {
        var URLObservacion = "@Url.Content("~/Certificados/BuscarViasEsquinas")";
        var Codigo = $('#CodigoCatastral').val();
        console.log(Codigo);
        var CodigoVia = $('#NombreVia').val();
        var ind1 = CodigoVia.indexOf("|") + 1;
        var ind2 = CodigoVia.indexOf("|", ind1) + 1;
        var ind3 = CodigoVia.indexOf("|", ind2) + 1;
        $.post(URLObservacion, {
            CodigoSector: Codigo.substring(2, 4), CodigoManzana: Codigo.substring(4, 7), CodigoLote: Codigo.substring(7, 10), CodigoLado: codlado,
            CodigoVia: CodigoVia.substring(ind1, ind2 - 1)
        },
        function (r) {
            var datos = "";
            $('#NombreViaEsq').children('option:not(:first)').remove();
            $.each(r.SolicitudUnidad, function (ind, item) {
                $('#NombreViaEsq').append($('<option>').text(item.Ubicacion).attr('value', item.Unidad));
                datos = datos + "/" + item.Ubicacion;
            });
            if (codlado) { $('#UnidadDireccion').val(datos.substring(1)) }
        });
    }
    function RecuperarUrbanizacion(ubicacion) {
        var URLObservacion = "@Url.Content("~/Certificados/BuscarUrbanizacion")";
        var Codigo = $('#CodigoCatastral').val();
        console.log(Codigo);
        $.post(URLObservacion, {
            CodigoSector: Codigo.substring(2, 4), CodigoManzana: Codigo.substring(4, 7), CodigoLote: Codigo.substring(7, 10),
        },
        function (r) {
            $('#NombreViaEsq').children('option:not(:first)').remove();
            if (r.SolicitudUnidad) {
                var datos = r.SolicitudUnidad;
                var ind1 = datos.indexOf("|") + 1; var ind2 = datos.indexOf("|", ind1) + 1; var ind3 = datos.indexOf("|", ind2) + 1;
                var ind4 = datos.indexOf("|", ind3) + 1;
                $('#Urbanizacion').val(datos.substring(0, ind1 - 1));
                $('#ManzanaUrbana').val(datos.substring(ind1, ind2 - 1));
                //var loteurb = "PARTE DEL LOTE " + datos.substring(ind2, ind3 - 1);
                var loteurb = datos.substring(ind2, ind3 - 1);
                $('#LoteUrbano').val(loteurb)
                var sublote = datos.substring(ind3, ind4 - 1);
                $('#SubLoteUrbano').val((sublote) ? sublote : "---");

            }
        });
    }
    RecuperarUrbanizacion();
    function RecuperarUrbanizacion(ubicacion) {
        var URLObservacion = "@Url.Content("~/Certificados/BuscarUrbanizacion")";
        var Codigo = $('#CodigoCatastral').val();
        console.log(Codigo);
        $.post(URLObservacion, {
            CodigoSector: Codigo.substring(2, 4), CodigoManzana: Codigo.substring(4, 7), CodigoLote: Codigo.substring(7, 10),
            CodigoUnico: $('#CodigoUnico').val()
        },
        function (r) {
            $('#NombreViaEsq').children('option:not(:first)').remove();
            if (r.SolicitudUnidad) {
                var datos = r.SolicitudUnidad;
                var ind1 = datos.indexOf("|") + 1; var ind2 = datos.indexOf("|", ind1) + 1; var ind3 = datos.indexOf("|", ind2) + 1;
                var ind4 = datos.indexOf("|", ind3) + 1;
                $('#Urbanizacion').val(datos.substring(0, ind1 - 1));
                $('#ManzanaUrbana').val(datos.substring(ind1, ind2 - 1));
                //var loteurb = "PARTE DEL LOTE " + datos.substring(ind2, ind3 - 1);
                var loteurb = datos.substring(ind2, ind3 - 1);
                $('#LoteUrbano').val(loteurb)
                var sublote = datos.substring(ind3, ind4 - 1);
                $('#SubLoteUrbano').val((sublote) ? sublote : "---");
                $('#InscripcionCatastral').val(datos.substring(ind4));

            }
        });
    }
</script>
