@model MSI.Catastros.Web.Funcionalidad.Certificados.CertificadosViewModel
<fieldset class="formulario p-3">
    <legend id="legInforme" style="margin-bottom:-10px;">Plano de Acumulación</legend>
    @using (Html.BeginForm("Registrar", "Certificado", FormMethod.Post, new { id = "frmCertificadosJuri", name = "frmCertificadosJuri" }))
    {
        @*<input type="hidden" id="FiltrarCodigoCorrelativo" />
            <input type="hidden" id="FiltrarCodigoCarta" />*@
        @Html.TextBoxFor(m => m.FiltrarCodigoCertificado, new { @class = "form-control change", type = "hidden" })
        @Html.AntiForgeryToken()

        <div class="row mt-3 px-3" style="display:none;">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label" id="lblTitulo" for="Titulo">Numero de Documento</label>
                    @Html.TextBoxFor(m => m.Titulo, new { @class = "form-control change", disabled = true })
                </div>
            </div>
        </div>
        <div class="row px-3">
            <div class="col-md-12">
                <table id="tablaCamposLotes" style="width:100%" class="table responsive display table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Lote</th>
                            <th>Código Catastral</th>
                            <th>Titulares-Copropietarios</th>
                            <th>Tipo Propietario</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <div class="row mt-3 px-3">
            <div class="col-md-2" style="display:none;">
                <div class="form-group">
                    @Html.LabelFor(model => model.ListTipoPersona, htmlAttributes: new { @class = "control-label" })
                    @Html.DropDownListFor(m => m.TipoPersonas, Model.ListTipoPersona, "- Tipo Destinatario -", new { @class = "form-control" })
                </div>
            </div>
            <div class="col-md-4" style="display:none;">
                <div class="form-group">
                    @Html.LabelFor(m => m.Solicitante, htmlAttributes: new { @class = "control-label" })@Html.TextAreaFor(m => m.Solicitante, new { @class = "form-control change", rows = "2" })
                </div>
            </div>
            <div class="col-md-2">
                <label class="control-label">Tipo de Inscripcción</label>
                @Html.DropDownListFor(m => m.TipoInscripcion, Model.ListTipoInscripcion, "- Tipo Inscripción -", new { @class = "form-control" })
                @*<select id="TipoInscripcion" class="form-control">
                        <option value=""> - Seleccione - </option>
                        <option value="Acumulación">ACUMULACIÓN</option>
                        <option value="Sub-División">SUB-DIVISIÓN</option>
                        <option value="Inmatriculación">INMATRICULACIÓN</option>
                    </select>*@
            </div>
            <div class="col-md-2">
                <label class="control-label">Ubicación Política</label>
                <input type="text" class="form-control" id="UbicacionPolitica" value="150131" />
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="control-label" id="lblCodigoCatastral" for="CodigoCatastral">Código Catastral</label>
                    <input type="text" class="form-control" id="CodigoCatastralVer" name="CodigoCatastralVer" disabled />
                    @Html.TextBoxFor(m => m.CodigoCatastral, new { @class = "form-control change", disabled = true, type ="hidden" })
                </div>
            </div>
            <div class=" col-md-2">
                <div class="form-group">
                    <label class="control-label" id="lblCodigoUnico" for="CodigoUnico">Código Unico Catastral</label>
                    @Html.TextBoxFor(m => m.CUC, new { @class = "form-control change", disabled = true })
                </div>
            </div>


        </div>
        <div class="row px-3">
            <div class="col-md-8">
                <label class="control-label" id="lblPartida" for="Partida">Ubicacion del Inmueble</label>
                @Html.TextAreaFor(m => m.Direccion, new { @class = "form-control change", rows = "1" })
            </div>


            <div class=" col-md-2" style="display:none;">
                <div class="form-group">
                    <label class="control-label" id="lblCodigoUnico" for="CodigoUnico">Código Unico Cat.</label>
                    @*@Html.TextBoxFor(m => m.Parrafo1, new { @class = "form-control change" })*@
                    @Html.TextBoxFor(m => m.CodigoUnico, new { @class = "form-control change", disabled = true })
                </div>
            </div>

        </div>
        <div class="row mt-3 px-3" style="display:none;">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="control-label" id="lblFechaGeneracion" for="FechaGeneracion">Fecha de Emisión</label>
                    @Html.TextBoxFor(m => m.FechaGeneracion, new { @class = "form-control change", type = "date", disabled = true })
                </div>
            </div>
        </div>
        <hr class="mx-3 mt-3 mb-0" />
        <div class="row px-3">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label" id="lblUrbanizacion" for="Urbanizacion">Urbanizacion</label>
                    @Html.TextBoxFor(m => m.Urbanizacion, new { @class = "form-control change", disabled = true })
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label" id="lblManzanaUrbana" for="ManzanaUrbana">Manzana</label>
                    @Html.TextBoxFor(m => m.ManzanaUrbana, new { @class = "form-control change", disabled = true })
                </div>
            </div>
        </div>
        <div class="row px-3">
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label" id="lblLoteUrbano" for="LoteUrbano">Lote</label>
                    @Html.TextBoxFor(m => m.LoteUrbano, new { @class = "form-control change", disabled = true })
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="control-label" id="lblSubLoteUrbano" for="SubLoteUrbano">SubLote</label>
                    @Html.TextBoxFor(m => m.SubLoteUrbano, new { @class = "form-control change", disabled = true })
                </div>
            </div>
        </div>
        <div class="row px-3">
            <div class="col-md-2">
                <label class="control-label">Inscripcion Catastral</label>
                <input type="text" class="form-control" style="text-transform:none;" id="InscripcionCatastral" />
            </div>
            <div class="col-md-2">
                <label class="control-label" id="lblRecibo" for="Recibo">Recibo</label>
                @*<input type="text" class="form-control" id="Recibo" />*@
                @Html.TextBoxFor(m => m.Recibo, new { @class = "form-control", @style = "text-transform:none;" })
            </div>
            <div class="col-md-2">
                <label class="control-label" id="lblHojaPlano" for="HojaPlano">Hoja de Plano:</label>
                @*<input type="text" class="form-control" id="HojaPlano" />*@
                @Html.TextBoxFor(m => m.HojaPlano, new { @class = "form-control", @style="text-transform:none;" })
            </div>
            <div class="col-md-2">
                <label class="control-label" id="lblEscalaPlano" for="EscalaPlano">Escala del Plano:</label>
                @*<input type="text" class="form-control" id="EscalaPlano" />*@
                @Html.TextBoxFor(m => m.EscalaPlano, new { @class = "form-control", @style = "text-transform:none;" })
            </div>
        </div>
        <div class="row mt-3 px-3">
            <div class="col-md-2">
                <div class="form-group">
                    <label class="control-label" id="lblNumeroSolicitud" for="NumeroSolicitud">N° Expediente</label>
                    @Html.TextBoxFor(m => m.NumeroSolicitud, new { @class = "form-control change", disabled = true })
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label" id="lblPartida" for="Partida">Antecedentes del predio</label>
                    <select id="Partida" class="" multiple="multiple"></select>
                </div>
            </div>
        </div>

        <div class="row  px-3">
            <div class="col-md-12">
                <div class="form-group">
                    <label class="control-label" id="lblAnotaciones" for="Anotaciones">Anotaciones Adicionales</label>
                    @Html.TextAreaFor(m => m.Anotaciones, new { @class = "form-control change", rows = "5" })
                </div>
            </div>
        </div>
        <hr class="mx-3 mt-0 mb-3" />

    }
</fieldset>




<script src="~/assets/vendor/bootstrap-multiselect/bootstrap-multiselect.js"></script>
<script src="~/assets/vendor/datatables-checkboxes/js/dataTables.checkboxes.min.js"></script>
<script>
    //$('input').keyup(function () { this.value = this.value.toLocaleUpperCase() });
    if ($('#NombreAreaSolicitante').val() == "") {
        $('#NombreTipoDocumento').val("");
    }
    var codCat = $('#CodigoCatastral').val();
    $('#CodigoCatastralVer').val(codCat.slice(0, 2) + "-" + codCat.slice(2, 4) + "-" + codCat.slice(4, 7) + "-" + codCat.slice(7, 10) + "-" + codCat.slice(10, 12) + "-" + codCat.slice(12, 14) + "-" + codCat.slice(14, 16) + "-" + codCat.slice(16, 19))

    tablaCamposLotes = $("#tablaCamposLotes").DataTable({
        "ajax": {
            "type": "POST", "datatype": "json",
            "url": "@Url.Content("~/Certificados/CargarLotesAcumulados")", 
            "data": function (d) {
                d.FiltrarCodigoTipoSolicitud = $('#FiltrarCodigoTipoSolicitud').val();
                d.FiltrarCodigoTipoDocumentoReg= $('#FiltrarCodigoTipoDocumentoReg').val(); 
                d.FiltrarNumeroSolicitud = $('#FiltrarNumeroSolicitud').val();
                d.FiltrarCodigoPeriodo = $('#FiltrarCodigoPeriodo').val();
                d.CodigoCatastral = $('#CodigoCatastral').val();
            }
        },
        "language": { "lengthMenu": "", "info": "", "emptyTable": "" }, "processing": true, "serverSide": false, "paging": false,
        "columns": [
            { "data": "LoteCodigoCatastral", "className": "text-center" },
            { "data": "CodigoCatastral", "className": "text-center" }, { "data": "Titular", "className": "text-center" }, { "data": "TipoPropietario", "className": "text-center" },
        ]
    });


    $(document).on('change', '.dt-checkboxes', function () {
        CrearCamposEntradas();
    });
    $('#TipoPersonas').change(function () {
        if (this.value == '010003') {
            var Titulares = '';
            tablaCamposLotes.column(2).data().each(function (value, index) {
                var ind = (index + 1);
                Titulares = Titulares + '\n' + value;
            });
            
            $('#Solicitante').val(Titulares.substring(1));
        } else {
            $.post("@Url.Content("~/Informes/BuscarSolicitudPersona")", { model: RetornarBusqueda() },
            function (r) {
                if ($('#TipoPersonas').val() === '010001') {
                    if (r.Solicitud.NombreSolicitante) {
                        $('#Solicitante').val(r.Solicitud.NombreSolicitante);
                    }
                } else {
                    if (r.Solicitud.NombreRepresentante) {
                        $('#Solicitante').val(r.Solicitud.NombreRepresentante);
                    }
                }
            });
        }
    });
    
    $('#Anotaciones').on('keydown', function (e) {
        var input = document.getElementById('Anotaciones');
        var caretPos = input.selectionStart;
        var value = this.value;
        if (e.keyCode == 13) {
            //event.preventDefault();
            //if (value.substring(caretPos - 1, caretPos) !== "*") {
            //    console.log('2a.', caretPos, value.length, '|', value.substring(0, caretPos), '|', value.substring(caretPos));
            //    $('#Anotaciones').val(value.substring(0, caretPos) + "|\n" + value.substring(caretPos));
            //    $('#Anotaciones').prop('selectionEnd', caretPos+2);
            //} else {
            //    $('#Anotaciones').val(value.substring(0, caretPos) + "\n" + value.substring(caretPos));
            //    $('#Anotaciones').prop('selectionEnd', caretPos + 1);
            //}
        }
    });
    var enlaceDocu = "@Url.Content("~/Certificados/CargarUnidadRRPP")";
    $.post(enlaceDocu, { CodigoUnico: $('#CodigoUnico').val(), Tipo: '2' }, function (r) {
        $('#Partida').children('option:not(:first)').remove();
        $.each(r.data, function (ind, item) {
            $('#Partida').append($('<option>').text(item.Text).attr('value', item.Value));
        });
        $('#Partida').multiselect({
            buttonWidth: '100%',
            allSelectedText: "Todos los documentos seleccionados",
            buttonClass: 'btn btn-default btn-sm',
            nonSelectedText: 'Seleccione una o más Partidas',
        });

        var ListaPartida;
        if ("@Model.PartidaString") {
            ListaPartida = "@Model.PartidaString".split("/");
            
            $('#Partida').multiselect('select', ListaPartida);
        }
    });
    RecuperarUrbanizacion();
    function RecuperarUrbanizacion(ubicacion) {
        var URLObservacion = "@Url.Content("~/Certificados/BuscarUrbanizacion")";
        var Codigo = $('#CodigoCatastral').val();
        console.log(Codigo);
        $.post(URLObservacion, {
            CodigoSector: Codigo.substring(2, 4), CodigoManzana: Codigo.substring(4, 7), CodigoLote: Codigo.substring(7, 10),
            CodigoUnico: $('#CodigoUnico').val()
        },
        function (r) {
            $('#NombreViaEsq').children('option:not(:first)').remove();
            if (r.SolicitudUnidad) {
                var datos = r.SolicitudUnidad;
                var ind1 = datos.indexOf("|") + 1; var ind2 = datos.indexOf("|", ind1) + 1; var ind3 = datos.indexOf("|", ind2) + 1;
                var ind4 = datos.indexOf("|", ind3) + 1;
                $('#Urbanizacion').val(datos.substring(0, ind1 - 1));
                $('#ManzanaUrbana').val(datos.substring(ind1, ind2 - 1));
                //var loteurb = "PARTE DEL LOTE " + datos.substring(ind2, ind3 - 1);
                var loteurb = datos.substring(ind2, ind3 - 1);
                $('#LoteUrbano').val(loteurb)
                var sublote = datos.substring(ind3,ind4 -1);
                $('#SubLoteUrbano').val((sublote) ? sublote : "---");
                $('#InscripcionCatastral').val(datos.substring(ind4));

            }
        });
    }

</script>
